<div class="content-header">
    <h1><i class="fas fa-mail-bulk"></i> All Mail</h1>
    <p class="subtitle">View all your emails from every folder</p>
</div>

<div id="allMailList" class="email-list">
    {% for email in emails %}
    <div class="email-card" data-email-id="{{ email.id }}">
        <div class="email-icon">
            <i class="fas fa-envelope"></i>
        </div>

        <div class="email-content">
            <div class="email-header">
                <h3 class="email-sender">{{ email.sender or "Unknown" }}</h3>

                {% if email.confidence is not none %}
                <span class="email-badge {{ 'danger' if email.is_phishing else 'safe' }}">
                    <i class="fas {{ 'fa-exclamation-triangle' if email.is_phishing else 'fa-check-circle' }}"></i>
                    {{ 'Phishing' if email.is_phishing else 'Safe' }} ({{ email.confidence }}%)
                </span>
                {% elif email.scanned %}
                <span class="email-badge safe"><i class="fas fa-check-circle"></i> Safe</span>
                {% else %}
                <span class="email-badge muted"><i class="fas fa-hourglass-half"></i> Scanning...</span>
                {% endif %}
            </div>

            <h4 class="email-subject">{{ email.subject or "(No Subject)" }}</h4>
            <p class="email-preview">{{ email.body }}</p>

            <div class="email-meta">
                <span>ID: {{ email.id[:8] }}...</span>
            </div>
        </div>

        <div class="email-actions">
            <button class="icon-btn view-btn" data-email-id="{{ email.id }}">
                <i class="fas fa-eye"></i>
            </button>

            <button class="icon-btn star-btn {{ 'starred' if email.starred else '' }}" data-email-id="{{ email.id }}"
                data-starred="{{ 'true' if email.starred else 'false' }}">
                <i class="{{ 'fas' if email.starred else 'far' }} fa-star"></i>
            </button>

            <button class="icon-btn flag-btn {{ 'flagged' if email.flagged else '' }}" data-email-id="{{ email.id }}"
                data-flagged="{{ 'true' if email.flagged else 'false' }}">
                <i class="{{ 'fas' if email.flagged else 'far' }} fa-flag"></i>
            </button>

            <button class="icon-btn learn-more-btn" data-email-id="{{ email.id }}">
                <i class="fas fa-info-circle"></i>
            </button>
        </div>
    </div>
    {% endfor %}
</div>

{% if next_page_token %}
<div class="load-more-container" style="text-align: center; margin: 20px 0;">
    <button class="btn btn-primary" id="loadMoreBtn" data-url="{{ url_for('all_mail', pageToken=next_page_token) }}">
        <i class="fas fa-chevron-down"></i> Load More
    </button>

</div>
{% endif %}

<script>
    document.addEventListener("click", function (e) {
        /* ---------------- VIEW EMAIL ---------------- */
        const viewBtn = e.target.closest(".view-btn");
        if (viewBtn) {
            viewEmail(viewBtn.dataset.emailId, viewBtn);
            return;
        }

        /* ---------------- BUTTON ACTIONS ---------------- */
        const starBtn = e.target.closest(".star-btn");
        const flagBtn = e.target.closest(".flag-btn");

        if (starBtn) toggleStar(starBtn);
        if (flagBtn) toggleFlag(flagBtn);
    });

    /* --------------- FUNCTIONS ---------------- */

    function toggleStar(btn) {
        const icon = btn.querySelector("i");
        const isStarred = btn.dataset.starred === 'true';
        const originalClass = icon.className;

        // Optimistic update
        icon.className = isStarred ? "far fa-star" : "fas fa-star";
        btn.dataset.starred = (!isStarred).toString();
        btn.classList.toggle('starred');

        fetch("/api/toggle-star", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                message_id: btn.dataset.emailId,
                star: !isStarred
            })
        })
            .then(res => {
                if (!res.ok) throw new Error("Failed");
            })
            .catch(() => {
                // Revert
                icon.className = originalClass;
                btn.dataset.starred = isStarred.toString();
                btn.classList.toggle('starred');
                alert("Failed to update star");
            });
    }

    function toggleFlag(btn) {
        const icon = btn.querySelector("i");
        const isFlagged = btn.dataset.flagged === 'true';
        const originalClass = icon.className;

        // Optimistic update
        icon.className = isFlagged ? "far fa-flag" : "fas fa-flag";
        btn.dataset.flagged = (!isFlagged).toString();
        btn.classList.toggle('flagged');

        fetch("/api/toggle-flag", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                message_id: btn.dataset.emailId,
                flag: !isFlagged
            })
        })
            .then(res => {
                if (!res.ok) throw new Error("Failed");
            })
            .catch(() => {
                // Revert
                icon.className = originalClass;
                btn.dataset.flagged = isFlagged.toString();
                btn.classList.toggle('flagged');
                alert("Failed to update flag");
            });
    }

    function viewEmail(emailId, btn) {
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        fetch(`/api/view-email?message_id=${encodeURIComponent(emailId)}`)
            .then(r => r.json())
            .then(data => {
                showModal(data);
            })
            .catch(() => alert("Failed to load email"))
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            });
    }

    function showModal(data) {
        const modal = document.createElement("div");
        modal.className = "email-modal";
        modal.innerHTML = `
            <div class="modal-overlay" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:999;"></div>
            <div class="modal-content" style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:20px;border-radius:12px;width:90%;max-width:600px;z-index:1000;box-shadow:0 10px 25px rgba(0,0,0,0.2);">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                    <h2 style="margin:0;font-size:1.2rem;">${data.subject || "No Subject"}</h2>
                    <button style="background:none;border:none;font-size:1.5rem;cursor:pointer;" class="modal-close">&times;</button>
                </div>
                <p><strong>From:</strong> ${data.sender}</p>
                <div style="font-size: 0.85rem; color: #666; margin-bottom: 10px;">${data.date || ''}</div>
                <hr>
                <div style="max-height:60vh; overflow-y:auto; margin-top:10px;">${data.body || "No content."}</div>
            </div>
        `;
        document.body.appendChild(modal);

        modal.querySelector(".modal-overlay").onclick = () => modal.remove();
        modal.querySelector(".modal-close").onclick = () => modal.remove();
    }
</script>