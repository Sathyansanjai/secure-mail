<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smail - Secure Mail</title>

    <!-- CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="main-app">

<!-- ================= TOP NAVBAR ================= -->
<nav class="top-navbar">
    <div class="nav-left">
        <button class="menu-toggle" id="menuToggle">
            <i class="fas fa-bars"></i>
        </button>
        <div class="app-brand">
            <i class="fas fa-shield-alt"></i>
            <span>Smail</span>
        </div>
    </div>

    <div class="nav-center">
        <div class="search-bar">
            <i class="fas fa-search"></i>
            <input type="text" placeholder="Search emails..." id="searchInput">
        </div>
    </div>

    <div class="nav-right">
        <button class="icon-btn" title="Refresh" onclick="refreshPage()">
            <i class="fas fa-sync-alt"></i>
        </button>

        <div class="user-profile">
            <img src="https://ui-avatars.com/api/?name={{ user_email }}&background=667eea&color=fff">
            <span>{{ user_email }}</span>
        </div>

        <a href="/logout" class="icon-btn logout-btn" title="Logout">
            <i class="fas fa-sign-out-alt"></i>
        </a>
    </div>
</nav>

<!-- ================= SIDEBAR ================= -->
<aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <button class="compose-btn" disabled>
            <i class="fas fa-plus"></i>
            <span>Compose</span>
        </button>
    </div>

    <div class="sidebar-menu">
        <a href="javascript:void(0)" class="menu-item active" data-page="inbox">Inbox <span class="badge" id="inbox-count">0</span></a>
        <a href="javascript:void(0)" class="menu-item" data-page="phishing">Phishing Attacks <span class="badge danger" id="phishing-count">0</span></a>
        <a href="javascript:void(0)" class="menu-item" data-page="trash">Trash</a>

        <div class="menu-divider"></div>

        <div class="stats-widget">
            <h4>Protection Stats</h4>
            <div class="stat-item">Total Emails <strong id="stat-total">0</strong></div>
            <div class="stat-item">Safe Emails <strong id="stat-safe" class="text-success">0</strong></div>
            <div class="stat-item">Threats Blocked <strong id="stat-phishing" class="text-danger">0</strong></div>
        </div>
    </div>
</aside>

<!-- ================= MAIN CONTENT ================= -->
<main class="main-content" id="mainContent">
    <div class="loading-spinner">
        <i class="fas fa-circle-notch fa-spin"></i>
        <p>Loading...</p>
    </div>
</main>

<!-- ================= JS ================= -->
<script>
// ---------------- Load Partial Pages ----------------
function loadPage(page) {
    const urlMap = {
        inbox: "/inbox",
        trash: "/trash",
        phishing: "/phishing-logs"
    };
    const url = urlMap[page] || "/inbox";

    const content = document.getElementById("mainContent");
    content.innerHTML = '<div class="loading-spinner"><i class="fas fa-circle-notch fa-spin"></i><p>Loading...</p></div>';

    fetch(url)
        .then(res => res.text())
        .then(html => {
            content.innerHTML = html;
            filterEmails(""); // reset search
        })
        .catch(err => {
            content.innerHTML = "<h2 style='padding:20px'>Failed to load page</h2>";
            console.error(err);
        });
}

// ---------------- Refresh Stats ----------------
function updateStats() {
    fetch('/api/stats')
        .then(res => res.json())
        .then(data => {
            document.getElementById("stat-total").innerText = data.total;
            document.getElementById("stat-safe").innerText = data.safe;
            document.getElementById("stat-phishing").innerText = data.phishing;

            document.getElementById("inbox-count").innerText = data.safe;
            document.getElementById("phishing-count").innerText = data.phishing;
        })
        .catch(console.error);
}

// ---------------- Sidebar Click Handler ----------------
document.querySelectorAll(".menu-item").forEach(item => {
    item.addEventListener("click", () => {
        document.querySelectorAll(".menu-item").forEach(mi => mi.classList.remove("active"));
        item.classList.add("active");
        const page = item.dataset.page;
        loadPage(page);
    });
});

// ---------------- Search Function ----------------
document.getElementById("searchInput").addEventListener("input", e => {
    filterEmails(e.target.value.toLowerCase());
});

function filterEmails(query) {
    document.querySelectorAll(".email-card").forEach(card => {
        const sender = card.querySelector(".email-sender")?.textContent.toLowerCase() || "";
        const subject = card.querySelector(".email-subject")?.textContent.toLowerCase() || "";
        const body = card.querySelector(".email-preview")?.textContent.toLowerCase() || "";
        card.style.display = sender.includes(query) || subject.includes(query) || body.includes(query) ? "flex" : "none";
    });
}

// ---------------- Refresh Button ----------------
function refreshPage() {
    const active = document.querySelector(".menu-item.active");
    if (active) loadPage(active.dataset.page);
    updateStats();
}

// ---------------- Auto-load inbox & stats ----------------
window.addEventListener("load", () => {
    loadPage("inbox");
    updateStats();
    setInterval(updateStats, 10000); // refresh stats every 10s
});
</script>

</body>
</html>
