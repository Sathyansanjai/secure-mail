<div class="content-header">
    <h1>
        {% if title == "Starred Mails" %}
        <i class="fas fa-star text-warning"></i>
        {% elif title == "Sent Mails" %}
        <i class="fas fa-paper-plane text-primary"></i>
        {% else %}
        <i class="fas fa-inbox"></i>
        {% endif %}
        {{ title or 'Inbox' }}
    </h1>
    <p class="subtitle">
        {% if title == "Sent Mails" %}
        Successfully delivered secure communications
        {% elif title == "Starred Mails" %}
        Important messages flagged for follow-up
        {% else %}
        Safe emails only - phishing threats automatically removed
        {% endif %}
    </p>
</div>

<div class="email-list" id="emailList">
    {% if emails|length == 0 %}
    <div class="empty-state">
        <i class="fas fa-inbox"></i>
        <h3>No messages found</h3>
        <p>This folder is currently empty.</p>
    </div>
    {% else %}
    {% for email in emails %}
    <div class="email-card {% if email.is_sent %}sent-variant{% endif %}" data-email-id="{{ email.id }}">
        <div class="email-icon">
            {% if email.is_sent %}
            <i class="fas fa-paper-plane"></i>
            {% elif email.starred %}
            <i class="fas fa-star text-warning"></i>
            {% else %}
            <i class="fas fa-envelope"></i>
            {% endif %}
        </div>

        <div class="email-content">
            <div class="email-header">
                <h3 class="email-sender">{{ email.sender }}</h3>

                {% if email.scanned %}
                <span class="email-badge {{ 'danger' if email.is_phishing else 'safe' }}">
                    <i class="fas {{ 'fa-shield-virus' if email.is_phishing else 'fa-shield-alt' }}"></i>
                    {{ 'Phishing' if email.is_phishing else 'Verified Safe' }}
                    {% if email.confidence %}({{ email.confidence }}%){% endif %}
                </span>
                {% elif not email.is_sent %}
                <span class="email-badge muted">
                    <i class="fas fa-hourglass-half"></i>
                    Scanning…
                </span>
                {% endif %}
            </div>

            <h4 class="email-subject">{{ email.subject }}</h4>
            <div class="email-date-mini">{{ email.date }}</div>
            <p class="email-preview">{{ email.body }}</p>

            {% if email.reason %}
            <div class="security-info {% if email.is_phishing %}phishing-variant{% else %}safe-variant{% endif %}">
                <p><i class="fas {% if email.is_phishing %}fa-shield-virus{% else %}fa-shield-alt{% endif %}"></i>
                    <strong>Analysis:</strong> {{ email.reason }}
                </p>
            </div>
            {% endif %}

            {% if email.explanation_html %}
            {{ email.explanation_html | safe }}
            {% endif %}
        </div>

        <div class="email-actions">
            {% if not email.is_sent %}
            <button class="icon-btn star-btn" data-email-id="{{ email.id }}" title="Star">
                <i
                    class="{% if email.starred %}fas{% else %}far{% endif %} fa-star {% if email.starred %}text-warning{% endif %}"></i>
            </button>

            <button class="icon-btn archive-btn" data-email-id="{{ email.id }}" title="Archive">
                <i class="fas fa-archive"></i>
            </button>
            {% endif %}

            <button class="icon-btn delete-btn" data-email-id="{{ email.id }}" title="Delete">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    </div>
    {% endfor %}
    {% endif %}
</div>
<script>
    document.addEventListener("click", function (e) {

        /* ---------------- VIEW EMAIL ---------------- */
        const card = e.target.closest(".email-card");
        if (card && !e.target.closest(".icon-btn")) {
            viewEmail(card.dataset.emailId, card);
            return;
        }

        /* ---------------- BUTTON ACTIONS ---------------- */
        const starBtn = e.target.closest(".star-btn");
        const archiveBtn = e.target.closest(".archive-btn");
        const deleteBtn = e.target.closest(".delete-btn");

        if (starBtn) toggleStar(starBtn);
        if (archiveBtn) archiveEmail(archiveBtn.dataset.emailId, archiveBtn);
        if (deleteBtn) deleteEmail(deleteBtn.dataset.emailId, deleteBtn);
    });

    /* ---------------- FUNCTIONS ---------------- */

    function toggleStar(btn) {
        const icon = btn.querySelector("i");
        const starred = icon.classList.contains("fas");
        const originalClass = icon.className;

        // Optimistic update
        icon.className = starred ? "far fa-star" : "fas fa-star text-warning";
        btn.style.pointerEvents = "none";

        fetch("/api/toggle-star", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                message_id: btn.dataset.emailId,
                star: !starred
            })
        })
            .then(res => {
                if (!res.ok) throw new Error("Failed");
            })
            .catch(() => {
                // Revert
                icon.className = originalClass;
                alert("Failed to update star");
            })
            .finally(() => {
                btn.style.pointerEvents = "auto";
            });
    }

    function archiveEmail(emailId, btn) {
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        }

        fetch("/api/archive-email", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message_id: emailId })
        }).then(res => {
            if (res.ok) {
                removeCard(emailId);
            } else {
                throw new Error("Failed");
            }
        }).catch(err => {
            alert("Failed to archive email");
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-archive"></i>';
            }
        });
    }

    function deleteEmail(emailId, btn) {
        if (!confirm("Delete this email?")) return;

        if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        }

        fetch("/api/delete-email", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message_id: emailId })
        }).then(res => {
            if (res.ok) {
                removeCard(emailId);
            } else {
                throw new Error("Failed");
            }
        }).catch(err => {
            alert("Failed to delete email");
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-trash"></i>';
            }
        });
    }

    function viewEmail(emailId, triggerElement) {
        let originalContent = "";
        if (triggerElement && triggerElement.classList.contains('email-card')) {
            triggerElement.style.opacity = "0.7";
            triggerElement.style.cursor = "wait";
        } else if (triggerElement) {
            originalContent = triggerElement.innerHTML;
            triggerElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            triggerElement.disabled = true;
        }

        fetch(`/api/view-email?message_id=${emailId}`)
            .then(r => r.json())
            .then(data => {
                showModal(data);
            })
            .catch(err => alert("Failed to load email"))
            .finally(() => {
                if (triggerElement && triggerElement.classList.contains('email-card')) {
                    triggerElement.style.opacity = "1";
                    triggerElement.style.cursor = "pointer";
                } else if (triggerElement) {
                    triggerElement.innerHTML = originalContent;
                    triggerElement.disabled = false;
                }
            });
    }

    function showModal(data) {
        const modal = document.createElement("div");
        modal.className = "email-modal";
        modal.innerHTML = `
            <div class="modal-overlay" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:999;"></div>
            <div class="modal-content" style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:20px;border-radius:12px;width:90%;max-width:600px;z-index:1000;box-shadow:0 10px 25px rgba(0,0,0,0.2);">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                    <h2 style="margin:0;font-size:1.2rem;">${data.subject || "No Subject"}</h2>
                    <button style="background:none;border:none;font-size:1.5rem;cursor:pointer;" class="modal-close">&times;</button>
                </div>
                <p><strong>From:</strong> ${data.sender}</p>
                <div style="font-size: 0.85rem; color: #666; margin-bottom: 10px;">${data.date || ''}</div>
                <hr>
                <div style="max-height:60vh; overflow-y:auto; margin-top:10px;">${data.body || "No content."}</div>
                <div style="margin-top:20px; text-align:right;">
                    <button id="ai-reply-btn" style="background:#4a90e2; color:white; border:none; padding:8px 16px; border-radius:6px; cursor:pointer;" title="Generate AI Draft">
                        ✨ Smart Reply
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        modal.querySelector(".modal-overlay").onclick = () => modal.remove();
        modal.querySelector(".modal-close").onclick = () => modal.remove();

        // AI Reply Handler
        const replyBtn = modal.querySelector("#ai-reply-btn");
        replyBtn.onclick = () => {
            replyBtn.disabled = true;
            replyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';

            fetch("/api/generate-reply", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    sender: data.sender,
                    subject: data.subject,
                    body: data.body
                })
            })
                .then(res => res.json())
                .then(resData => {
                    if (resData.draft) {
                        // Store draft to populate compose window
                        localStorage.setItem("smart_reply_draft", resData.draft);
                        localStorage.setItem("smart_reply_to", data.sender);
                        localStorage.setItem("smart_reply_subject", "Re: " + (data.subject || ""));

                        // Redirect to compose
                        modal.remove();
                        document.querySelector(".compose-btn").click();
                    } else {
                        alert("Could not generate reply.");
                        replyBtn.disabled = false;
                        replyBtn.textContent = "✨ Smart Reply";
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert("AI Error");
                    replyBtn.disabled = false;
                    replyBtn.textContent = "✨ Smart Reply";
                });
        };
    }

    function removeCard(emailId) {
        const card = document.querySelector(`[data-email-id="${emailId}"]`);
        if (card) {
            card.style.transform = "translateX(50px)";
            card.style.opacity = "0";
            setTimeout(() => card.remove(), 300);
        }
    }
</script>